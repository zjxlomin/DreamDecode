<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>내 정보 - Dream Decode</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" th:href="@{/images/favicon.ico}" />

    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet" />

    <!-- Bootstrap -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous"
    >
    <link href="/css/common.css" rel="stylesheet" th:href="@{/css/common.css}" />
    <link href="/css/dreams.css" rel="stylesheet" th:href="@{/css/dreams.css}" />
</head>
<body class="bg-dark text-white">

<!-- Navigation -->
<div th:replace="~{fragments/nav :: nav(false)}"></div>

<!-- 본문 -->
<main class="container" style="margin-top: 100px; max-width: 720px;">
    <h2 class="mb-4">내 정보</h2>

    <!-- 내 정보 수정 카드 -->
    <div class="card bg-secondary text-white mb-4">
        <div class="card-body">
            <form id="profileForm">
                <div class="mb-3">
                    <label for="profileEmail" class="form-label">이메일</label>
                    <input type="email" class="form-control" id="profileEmail" readonly />
                    <div class="form-text text-light">
                        이메일은 변경할 수 없습니다.
                    </div>
                </div>

                <div class="mb-3">
                    <label for="profileName" class="form-label">이름</label>
                    <input type="text" class="form-control" id="profileName" required />
                </div>

                <div class="mb-3">
                    <label class="form-label d-block">성별</label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio"
                               name="profileGender" id="profileGenderMale" value="1">
                        <label class="form-check-label" for="profileGenderMale">남성</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio"
                               name="profileGender" id="profileGenderFemale" value="2">
                        <label class="form-check-label" for="profileGenderFemale">여성</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="profileBirthday" class="form-label">생년월일</label>
                    <input type="date" class="form-control" id="profileBirthday" required />
                </div>

                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">
                        정보 수정 저장
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 비밀번호 변경 카드 -->
    <div class="card bg-secondary text-white">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <h5 class="card-title mb-1">비밀번호 변경</h5>
                <small class="text-light">현재 비밀번호 확인 후 새 비밀번호로 변경할 수 있습니다.</small>
            </div>
            <button type="button" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                비밀번호 변경
            </button>
        </div>
    </div>
</main>

<!-- 비밀번호 변경 모달 -->
<div class="modal fade" id="changePasswordModal" tabindex="-1"
     aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="changePasswordModalLabel">비밀번호 변경</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- 1단계: 현재 비밀번호 확인 -->
                <div id="pwChangeStep1">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">현재 비밀번호</label>
                        <input type="password" class="form-control" id="currentPassword" />
                    </div>
                    <small class="text-muted">
                        현재 사용 중인 비밀번호를 입력한 뒤, "확인" 버튼을 눌러주세요.
                    </small>
                </div>

                <!-- 2단계: 새 비밀번호 입력 -->
                <div id="pwChangeStep2" class="d-none">
                    <hr class="border-secondary opacity-50 my-3" />
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">새 비밀번호</label>
                        <input type="password" class="form-control" id="newPassword" />
                        <small class="form-text text-muted">
                            영문, 숫자를 모두 포함한 8~20자 비밀번호를 사용해 주세요.
                        </small>
                        <div class="form-text text-danger d-none" id="newPasswordError"></div>
                    </div>

                    <div class="mb-3">
                        <label for="newPasswordConfirm" class="form-label">새 비밀번호 확인</label>
                        <input type="password" class="form-control" id="newPasswordConfirm" />
                        <div class="form-text text-danger d-none" id="newPasswordConfirmError"></div>
                    </div>
                </div>
            </div>

            <div class="modal-footer border-0">
                <!-- 1단계 버튼 -->
                <div id="pwChangeStep1Buttons" class="w-100 d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="checkCurrentPasswordBtn">확인</button>
                </div>

                <!-- 2단계 버튼 -->
                <div id="pwChangeStep2Buttons" class="w-100 d-flex justify-content-between d-none">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="changePasswordBtn">비밀번호 변경</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 공통 Auth 모달들 (로그인/회원가입/비번찾기 등) -->
<div th:replace="~{fragments/auth :: auth-modals}"></div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
<script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"
></script>
<script src="/js/dreams.js" th:src="@{/js/dreams.js}"></script>
<script src="/js/auth.js"></script> <!-- AT 관리 / 로그인 / 회원가입 / 비번찾기 -->

<script>
    let pwChangeVerified = false;

    // 마이페이지에서만 사용하는 비밀번호 규칙 검사
    function validateProfilePasswordRules(pw) {
        if (!pw) return '비밀번호를 입력해 주세요.';
        if (pw.length < 8 || pw.length > 20) {
            return '비밀번호는 8~20자여야 합니다.';
        }
        if (!/[A-Za-z]/.test(pw) || !/[0-9]/.test(pw)) {
            return '비밀번호는 영문과 숫자를 모두 포함해야 합니다.';
        }
        return '';
    }

    $(function () {
        // auth.js 에서 정의된 getAccessToken 사용
        const token = getAccessToken();
        if (!token) {
            alert('로그인이 필요합니다.');
            window.location.href = '/';
            return;
        }

        // 생년월일: 오늘까지만 선택 가능
        const today = new Date().toISOString().split("T")[0];
        $('#profileBirthday').attr('max', today);

        // ===== 내 정보 불러오기 =====
        $.ajax({
            url: '/api/users/me',
            method: 'GET',
            beforeSend: function (xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + token);
            },
            success: function (res) {
                $('#profileEmail').val(res.email || '');
                $('#profileName').val(res.name || '');
                if (res.gender) {
                    $('input[name="profileGender"][value="' + res.gender + '"]').prop('checked', true);
                }
                if (res.birthday) {
                    $('#profileBirthday').val(res.birthday);
                }
                if (res.createdAt) {
                    $('#profileCreatedAt').text(
                        res.createdAt.replace('T', ' ').substring(0, 16)
                    );
                }
            },
            error: function () {
                alert('내 정보를 불러오는데 실패했습니다.');
            }
        });

        // ===== 내 정보 수정 저장 =====
        $('#profileForm').on('submit', function (e) {
            e.preventDefault();

            const name = $('#profileName').val().trim();
            const birthday = $('#profileBirthday').val();
            const gender = $('input[name="profileGender"]:checked').val();

            if (!name || !birthday || !gender) {
                alert('이름, 성별, 생년월일을 모두 입력해 주세요.');
                return;
            }

            $.ajax({
                url: '/api/users/me',
                method: 'PUT',
                contentType: 'application/json',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                },
                data: JSON.stringify({
                    name: name,
                    birthday: birthday,
                    gender: parseInt(gender, 10)
                }),
                success: function () {
                    alert('내 정보가 수정되었습니다.');
                },
                error: function (xhr) {
                    const res = xhr.responseJSON;
                    const msg = res && res.message ? res.message : '정보 수정에 실패했습니다.';
                    alert(msg);
                }
            });
        });

        // ===== 비밀번호 변경 모달 열릴 때 초기화 =====
        $('#changePasswordModal').on('show.bs.modal', function () {
            pwChangeVerified = false;
            $('#currentPassword').val('');
            $('#newPassword').val('').removeClass('is-invalid');
            $('#newPasswordConfirm').val('').removeClass('is-invalid');
            $('#newPasswordError').addClass('d-none').text('');
            $('#newPasswordConfirmError').addClass('d-none').text('');

            $('#pwChangeStep1').removeClass('d-none');
            $('#pwChangeStep2').addClass('d-none');
            $('#pwChangeStep1Buttons').removeClass('d-none');
            $('#pwChangeStep2Buttons').addClass('d-none');
        });

        // ===== 1단계: 현재 비밀번호 확인 =====
        $('#checkCurrentPasswordBtn').on('click', function () {
            const currentPw = $('#currentPassword').val();
            if (!currentPw) {
                alert('현재 비밀번호를 입력해 주세요.');
                return;
            }

            $.ajax({
                url: '/api/users/me/check-password',
                method: 'POST',
                contentType: 'application/json',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                },
                data: JSON.stringify({ currentPassword: currentPw }),
                success: function (res) {
                    pwChangeVerified = true;
                    $('#pwChangeStep1').addClass('d-none');
                    $('#pwChangeStep2').removeClass('d-none');
                    $('#pwChangeStep1Buttons').addClass('d-none');
                    $('#pwChangeStep2Buttons').removeClass('d-none');

                    alert((res && res.message) || '비밀번호가 확인되었습니다.\n새 비밀번호를 입력해 주세요.');
                },
                error: function (xhr) {
                    pwChangeVerified = false;
                    const res = xhr.responseJSON;
                    const msg = res && res.message ? res.message : '현재 비밀번호가 일치하지 않습니다.';
                    alert(msg);
                }
            });
        });

        // ===== 2단계: 새 비밀번호로 변경 =====
        $('#changePasswordBtn').on('click', function () {
            if (!pwChangeVerified) {
                alert('먼저 현재 비밀번호를 확인해 주세요.');
                return;
            }

            const currentPw = $('#currentPassword').val();
            const newPw = $('#newPassword').val();
            const newPwConfirm = $('#newPasswordConfirm').val();

            $('#newPassword').removeClass('is-invalid');
            $('#newPasswordConfirm').removeClass('is-invalid');
            $('#newPasswordError').addClass('d-none').text('');
            $('#newPasswordConfirmError').addClass('d-none').text('');

            const ruleMsg = validateProfilePasswordRules(newPw);
            if (ruleMsg) {
                $('#newPassword').addClass('is-invalid');
                $('#newPasswordError').removeClass('d-none').text(ruleMsg);
                $('#newPassword').focus();
                return;
            }

            if (newPw !== newPwConfirm) {
                $('#newPasswordConfirm').addClass('is-invalid');
                $('#newPasswordConfirmError')
                    .removeClass('d-none')
                    .text('새 비밀번호와 비밀번호 확인이 일치하지 않습니다.');
                $('#newPasswordConfirm').focus();
                return;
            }

            $.ajax({
                url: '/api/users/me/change-password',
                method: 'POST',
                contentType: 'application/json',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                },
                data: JSON.stringify({
                    currentPassword: currentPw,
                    newPassword: newPw
                }),
                success: function (res) {
                    alert((res && res.message) || '비밀번호가 성공적으로 변경되었습니다.');
                    $('#changePasswordModal').modal('hide');
                },
                error: function (xhr) {
                    const res = xhr.responseJSON;
                    const msg = res && res.message
                        ? res.message
                        : '비밀번호 변경에 실패했습니다.\n다시 시도해 주세요.';
                    alert(msg);
                }
            });
        });

    });
</script>

</body>
</html>
